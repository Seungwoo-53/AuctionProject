<!doctype html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>경매</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link th:href="@{/css/AuctionItems.css}" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script th:if="${successMessage}" th:inline="javascript">
        alert([[${successMessage}]]);
    </script>
    <script th:if="${errorMessage}" th:inline="javascript">
        alert([[${errorMessage}]]);
    </script>
</head>

<body>
<!-- header -->
<div th:insert="~{common/header :: headerFragment}"></div>
<!-- header -->


<!-- 경매물품 구간 -->
<section class="py-3 text-center container">
    <div>
        <!--            <div class="row py-lg-4">-->
        <div class="col-lg-6 col-md-8 mx-auto py-3 mb-4 border-bottom">
            <div th:if="${not item.enabled}">
                <h1 class="mb-5">경매 종료</h1>
            </div>
            <h2 th:text="${item.title}"></h2>
            <img th:src="${item.url}" alt="Item Image" />
            <p th:text="${item.info}"></p>
        </div>
    </div>
    <div>
        <div class="col-lg-6 col-md-8 mx-auto py-3 mb-4 border-bottom">
            <p>낙찰자 이름 : <span th:text="${memberUsername}"></span></p>
            <p>낙찰 금액 :
                <span th:if="${item.price >= 1000}" data-th-text="${#numbers.formatInteger(item.price, 3, 'COMMA') + '원'}"></span>
                <span th:if="${item.price < 1000}" th:text="${item.price + '원'}"></span>
            </p>
            <div class="text-body-secondary text-end" th:each="remainingMillis : ${remainingMillisList}">
                <small>남은 시간: </small>
                <small class="countdown" th:attr="data-countdown-millis=${remainingMillis}"></small>
            </div>
        </div>
    </div>

    <div class="col-lg-6 col-md-8 mx-auto py-2 mb-4">
        <form id="priceForm" th:action="@{/item/detail/{id}(id=${item.id})}" method="post" th:if="${item.enabled}">
            <div class="d-flex align-items-center justify-content-center">
                <label for="inputPrice" class="me-2">입력 금액:</label>
                <div class="input-group w-50">
                    <input type="text" id="inputPrice" name="price" th:value="${item.price}" required class="form-control"/>

                    <!-- 1000원씩 더하고 빼는 버튼 추가 -->
                    <div class="input-group-append mx-2">
                        <button type="button" onclick="add1000()" class="btn btn-secondary"><i class="fa-solid fa-arrow-up"></i></button>
                        <button type="button" onclick="subtract1000()" class="btn btn-secondary"><i class="fa-solid fa-arrow-down"></i></button>
                    </div>
                </div>
            </div>

            <div class="my-2" th:if="${item.enabled}">
                <p>
                    <span sec:authentication="name"></span>
                    <span>님의 보유 포인트 :</span>
                    <span th:if="${point >= 1000}" th:text="${#numbers.formatInteger(point, 3, 'COMMA')} + '원'"></span>
                    <span th:if="${point < 1000}" th:text="${point + '원'}"></span>
                </p>
            </div>

            <button type="submit" class="btn btn-primary w-50 my-2 py-1 btn-secondary">입찰</button>

            <div th:if="${showAuctionConfirmationButton}">
                <a class="btn btn-primary w-100 py-2 btn-secondary" th:href="@{item/final/{id}(id=${item.id})}">경매 아이템 확정</a>
            </div>
        </form>
        <small class="text-body-secondary text-end">조회수 : </small>
        <small class="text-body-secondary text-end" th:text="${item.view_count}"></small>
        <!-- JavaScript 코드 추가 -->
        <script src="https://cdn.rawgit.com/hilios/jQuery.countdown/2.2.0/dist/jquery.countdown.min.js"></script>
        <script th:inline="javascript">
            /*<![CDATA[*/
            $(document).ready(function () {
                /* Initialize countdown for each element with class 'countdown' */
                $('.countdown').each(function () {
                    var countdownMillis = $(this).data('countdown-millis');
                    $(this).countdown(countdownMillis)
                        .on('update.countdown', function (event) {
                            $(this).text(event.strftime('%H:%M:%S'));
                        })
                        .on('finish.countdown', function () {
                            $(this).text('Expired');
                        });
                });
            });

            function add1000() {
                var inputPriceElement = document.getElementById('inputPrice');
                var currentPrice = parseInt(inputPriceElement.value);
                var newPrice = currentPrice + 1000;
                inputPriceElement.value = newPrice;
            }

            function subtract1000() {
                var inputPriceElement = document.getElementById('inputPrice');
                var currentPrice = parseInt(inputPriceElement.value);
                var itemPrice = /*[[${itemPrice}]]*/; // Thymeleaf에서 전달받은 값 사용

                var newPrice = currentPrice - 1000;
                if (newPrice >= itemPrice) {
                    inputPriceElement.value = newPrice;
                    validatePrice(itemPrice); // itemPrice를 validatePrice 함수에 전달
                }
            }

            function validatePrice(itemPrice) {
                var inputPriceElement = document.getElementById('inputPrice');
                var currentPrice = parseInt(inputPriceElement.value);


                if (currentPrice == itemPrice) {
                    alert("가격은 현재 아이템 가격보다 낮아질 수 없습니다.");
                    // 또는 다른 방법으로 사용자에게 경고 메시지를 표시할 수 있습니다.
                    // 예를 들어 Bootstrap의 modal을 사용하거나, 특정 영역에 메시지를 표시하는 등의 방법이 있습니다.
                }
            }
            /*]]>*/
        </script>
        <script>
            $(document).ready(function() {
                // 모든 countdown 클래스를 가진 엘리먼트를 찾습니다.
                $('.countdown').each(function() {
                    var $this = $(this);
                    var countdownMillis = parseInt($this.data('countdown-millis'));

                    // 갱신 함수를 정의합니다.
                    function updateCountdown() {
                        var seconds = Math.floor(countdownMillis / 1000);
                        var hours = Math.floor(seconds / 3600);
                        var minutes = Math.floor((seconds % 3600) / 60);
                        var remainingSeconds = seconds % 60;

                        $this.text(hours + '시간 ' + minutes + '분 ' + remainingSeconds + '초');

                        // 1초 간격으로 갱신합니다.
                        countdownMillis -= 1000;

                        // 시간이 초과되면 타이머를 중지합니다.
                        if (countdownMillis < 0) {
                            clearInterval(intervalId);
                            $this.text('경매 종료');
                        }
                    }

                    // 초기 호출 및 1초마다 갱신합니다.
                    updateCountdown();
                    var intervalId = setInterval(updateCountdown, 1000);
                });
            });
        </script>
    </div>
</section>

<!-- footer 시작 -->
<div th:insert="~{common/footer :: footerFragment}"></div>
<!-- footer 끝  -->

<script src="https://kit.fontawesome.com/60b75f9d43.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
        integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js"
        integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+"
        crossorigin="anonymous"></script>
</body>

</html>